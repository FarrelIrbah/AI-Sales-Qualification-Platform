---
phase: 05-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - package.json
  - src/app/(protected)/dashboard/page.tsx
  - src/app/(protected)/dashboard/_components/filter-bar.tsx
  - src/app/(protected)/dashboard/_components/lead-card.tsx
  - src/app/(protected)/dashboard/_components/lead-grid.tsx
autonomous: true

must_haves:
  truths:
    - "User sees all analyzed leads in a card grid sorted by score (highest first)"
    - "User can filter leads by score range (Hot/Warm/Cold toggles)"
    - "User can filter leads by ICP match percentage"
    - "User can filter leads by industry dropdown"
    - "User can filter leads by analysis date range"
    - "User can change sort order"
    - "Filters persist in URL and survive page refresh"
    - "Empty states show appropriate messages"
  artifacts:
    - path: "src/app/(protected)/dashboard/page.tsx"
      provides: "Server Component dashboard page with data fetching"
      min_lines: 30
    - path: "src/app/(protected)/dashboard/_components/filter-bar.tsx"
      provides: "Client component with filter controls using nuqs"
      exports: ["FilterBar"]
    - path: "src/app/(protected)/dashboard/_components/lead-card.tsx"
      provides: "Lead card with score, company info, collapsed state"
      exports: ["LeadCard"]
    - path: "src/app/(protected)/dashboard/_components/lead-grid.tsx"
      provides: "Client component managing card grid and expand state"
      exports: ["LeadGrid"]
  key_links:
    - from: "src/app/(protected)/dashboard/page.tsx"
      to: "src/lib/dashboard/queries.ts"
      via: "server-side data fetching"
      pattern: "getDashboardLeads"
    - from: "src/app/(protected)/dashboard/_components/filter-bar.tsx"
      to: "URL search params"
      via: "nuqs useQueryState"
      pattern: "useQueryState|parseAsString"
---

<objective>
Build the dashboard page with lead card grid and filter bar. Users see all their analyzed leads displayed as cards sorted by score, and can filter/sort using a horizontal filter bar that persists state in URL parameters.

Purpose: This is the core dashboard experience - DASH-01 (view leads), DASH-03/04/05/06 (filters). The card grid is the collapsed-state view; expanding detail comes in plan 03.
Output: Working dashboard page with filterable, sortable lead card grid.
</objective>

<execution_context>
@C:\Users\farre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\farre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard/05-CONTEXT.md
@.planning/phases/05-dashboard/05-RESEARCH.md
@.planning/phases/05-dashboard/05-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/dashboard/queries.ts
@src/lib/dashboard/utils.ts
@src/components/ui/card.tsx
@src/components/ui/button.tsx
@src/components/ui/select.tsx
@src/components/ui/badge.tsx
@src/components/analysis/lead-score-card.tsx
@src/app/(protected)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install nuqs and build dashboard page with filter bar</name>
  <files>
    package.json
    src/app/(protected)/dashboard/page.tsx
    src/app/(protected)/dashboard/_components/filter-bar.tsx
  </files>
  <action>
    1. Install nuqs: `npm install nuqs`

    2. Create `src/app/(protected)/dashboard/_components/filter-bar.tsx` as 'use client' component:

    **Filter state with nuqs** - use `useQueryState` for each filter:
    - `scoreRange`: parseAsString, default '' (empty = all). Values: 'hot' (70-100), 'warm' (40-69), 'cold' (0-39), '' (all)
    - `icpMin`: parseAsInteger, default undefined
    - `icpMax`: parseAsInteger, default undefined
    - `industry`: parseAsString, default ''
    - `dateFrom`: parseAsString, default ''
    - `dateTo`: parseAsString, default ''
    - `sortBy`: parseAsString, default 'score'. Values: 'score', 'icpMatch', 'date', 'name'
    - `sortDir`: parseAsString, default 'desc'

    **UI layout** - horizontal bar above grid:
    - Row 1: Score range quick-select toggles (All | Hot | Warm | Cold) as Button group with variant="outline" and active state. Use green/yellow/red color accents for Hot/Warm/Cold.
    - Row 2: Industry dropdown (Select component populated from `industries` prop), ICP match range (two number inputs, min/max), Date range (two date inputs), Sort dropdown (Score/ICP Match/Date/Name + Asc/Desc toggle)
    - Show active filter count badge next to a "Clear filters" button when any filters are active
    - Show result count: "{N} leads" text

    **Props:**
    - `industries: string[]` - available industry options (passed from server)
    - `totalCount: number` - total lead count for display
    - `onFiltersChange: (filters: DashboardFilters) => void` - callback when filters change

    Actually, since nuqs manages URL state and the page is a Server Component that reads searchParams, the filter bar just needs to update URL params. The server component re-renders automatically.

    Define a `DashboardFilters` type matching the query function's filter params. Export it from filter-bar.tsx or a shared types location.

    3. Rewrite `src/app/(protected)/dashboard/page.tsx` as Server Component:

    - Import `getDashboardLeads`, `getDashboardLeadCount`, `getIndustryOptions` from queries
    - Read `searchParams` from page props (Next.js 16 async searchParams)
    - Parse searchParams into filter object:
      - Map scoreRange 'hot'/'warm'/'cold' to scoreMin/scoreMax numbers
      - Pass through industry, dateFrom, dateTo, sortBy, sortDir
    - Call `getDashboardLeads(filters)` and `getIndustryOptions()` in parallel
    - Render:
      - Page header: "Dashboard" title + "Analyze New Lead" button linking to /analyze
      - FilterBar component (client) with industries and totalCount props
      - LeadGrid component (client) with leads data
      - Empty states:
        - No leads at all: "No leads analyzed yet" with CTA button to /analyze
        - No results after filtering: "No leads match your filters" with "Clear filters" link
    - Use Suspense boundary around the lead grid for streaming
  </action>
  <verify>
    `npm run build` compiles successfully. Visit /dashboard - page renders without errors. Filter bar displays with all controls.
  </verify>
  <done>
    nuqs installed. Dashboard page fetches filtered data server-side. Filter bar renders with score toggles, industry dropdown, ICP range, date range, and sort controls. Filters update URL params. Empty states display correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build lead card and grid components</name>
  <files>
    src/app/(protected)/dashboard/_components/lead-card.tsx
    src/app/(protected)/dashboard/_components/lead-grid.tsx
  </files>
  <action>
    1. Create `src/app/(protected)/dashboard/_components/lead-card.tsx` as 'use client' component:

    **Collapsed card state** - shows summary info:
    - Left section: Large color-coded score number (reuse getScoreColor pattern from lead-score-card.tsx: green >= 70, yellow >= 40, red < 40) with score label underneath
    - Middle section: Company name (bold, truncated), industry badge, employee count, location
    - Right section: ICP match % badge (color-coded same thresholds), top pitch angle headline (truncated, italic), analysis date (relative or YYYY-MM-DD)
    - Card has hover state (subtle shadow/border change) and cursor-pointer
    - Three-dot menu (lucide MoreVertical icon) in top-right corner with onClick handler (don't build menu contents yet - plan 03 adds actions)

    **Props:**
    ```typescript
    interface LeadCardProps {
      analysis: Analysis
      company: Company
      isExpanded: boolean
      onToggleExpand: () => void
      onAction: (action: string, analysisId: string) => void
    }
    ```

    - onClick on card body calls `onToggleExpand`
    - Card uses the existing Card/CardContent components from ui/card
    - Use responsive layout: on mobile, stack score left + info right in 2 columns; on desktop, use the 3-section layout

    2. Create `src/app/(protected)/dashboard/_components/lead-grid.tsx` as 'use client' component:

    **Grid management:**
    - Props: `leads: Array<{ analysis: Analysis; company: Company }>` plus action callbacks
    - State: `expandedId: string | null` - which card is currently expanded
    - Render leads as a vertical list of LeadCard components (not CSS grid - cards expand in-place, so vertical stack works better)
    - Gap between cards: `space-y-4`
    - When a card is expanded, show expanded detail section below the card (placeholder div for now with text "Detail view - Plan 03"). Plan 03 will fill in the expanding detail.
    - Clicking an expanded card collapses it (toggle behavior)
    - Clicking a different card expands it and collapses the previous one
    - Smooth transition: use CSS transition on max-height or use Radix Collapsible (already installed) for expand/collapse animation

    Use `@radix-ui/react-collapsible` for the expand/collapse - wrap the detail section in Collapsible with `open={isExpanded}`. This ensures accessible expand/collapse with animation support.
  </action>
  <verify>
    `npm run build` compiles. Visit /dashboard with existing analysis data - cards render with scores, company info, and ICP match. Clicking a card shows expanded placeholder. Clicking another card collapses the first.
  </verify>
  <done>
    Lead cards display score (color-coded), company name, industry, ICP match %, and top pitch angle. Cards expand/collapse with only one expanded at a time. Grid renders as vertical stack with smooth Collapsible animation.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Dashboard page loads at /dashboard
- Filter bar shows score toggles, industry dropdown, ICP/date filters, sort controls
- Changing filters updates URL params (visible in address bar)
- Page refresh preserves filter state
- Lead cards show all summary info with correct score colors
- Card expand/collapse works (one at a time)
- Empty states appear when no leads or no filter matches
</verification>

<success_criteria>
- DASH-01: Lead list displays sorted by score (highest first)
- DASH-03: Score range filter works (Hot/Warm/Cold toggles)
- DASH-04: ICP match filter works
- DASH-05: Industry filter works (populated from real data)
- DASH-06: Date filter works
- Filters combine correctly (AND logic)
- URL-based state persists across refresh
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard/05-02-SUMMARY.md`
</output>
