---
phase: 05-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/app/(protected)/dashboard/_components/lead-detail.tsx
  - src/app/(protected)/dashboard/_components/lead-grid.tsx
  - src/app/(protected)/dashboard/_components/lead-card.tsx
  - src/app/(protected)/dashboard/_components/action-menu.tsx
autonomous: true

must_haves:
  truths:
    - "User can click lead card to see full analysis detail (score breakdown, insights, pitches, objections)"
    - "Expanded detail shows collapsible sections that user can open individually"
    - "Only one card is expanded at a time"
    - "User sees key metrics bar at top of expanded view"
  artifacts:
    - path: "src/app/(protected)/dashboard/_components/lead-detail.tsx"
      provides: "Expanded detail view with all analysis sections"
      exports: ["LeadDetail"]
    - path: "src/app/(protected)/dashboard/_components/action-menu.tsx"
      provides: "Three-dot action menu for lead cards"
      exports: ["ActionMenu"]
  key_links:
    - from: "src/app/(protected)/dashboard/_components/lead-detail.tsx"
      to: "src/components/analysis/score-breakdown.tsx"
      via: "component reuse"
      pattern: "ScoreBreakdown|CompanyInsights|PitchAngles|ObjectionCards"
    - from: "src/app/(protected)/dashboard/_components/lead-grid.tsx"
      to: "src/app/(protected)/dashboard/_components/lead-detail.tsx"
      via: "renders inside Collapsible"
      pattern: "LeadDetail"
---

<objective>
Build the expanding card detail view and action menus. When a user clicks a lead card, it expands in-place showing full analysis detail (score breakdown, insights, pitch angles, objections) in collapsible sections. Add three-dot action menus with archive, re-analyze, copy, and export actions.

Purpose: Covers DASH-02 (full analysis detail), DASH-07 (CSV export), DASH-08 (clipboard copy), DASH-09 (archive), DASH-10 (re-analyze). Completes all dashboard requirements.
Output: Working expanding detail view with all actions functional.
</objective>

<execution_context>
@C:\Users\farre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\farre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard/05-CONTEXT.md
@.planning/phases/05-dashboard/05-01-SUMMARY.md
@.planning/phases/05-dashboard/05-02-SUMMARY.md
@src/components/analysis/score-breakdown.tsx
@src/components/analysis/company-insights.tsx
@src/components/analysis/pitch-angles.tsx
@src/components/analysis/objection-cards.tsx
@src/components/ui/collapsible.tsx
@src/lib/dashboard/queries.ts
@src/lib/dashboard/utils.ts
@src/app/(protected)/dashboard/_components/lead-grid.tsx
@src/app/(protected)/dashboard/_components/lead-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build expanding detail view with reused analysis components</name>
  <files>
    src/app/(protected)/dashboard/_components/lead-detail.tsx
    src/app/(protected)/dashboard/_components/lead-grid.tsx
  </files>
  <action>
    1. Create `src/app/(protected)/dashboard/_components/lead-detail.tsx` as 'use client' component:

    **Props:**
    ```typescript
    interface LeadDetailProps {
      analysis: Analysis
      company: Company
    }
    ```

    **Layout - expanded detail panel:**
    - Appears below the card when expanded, inside a bordered container with subtle background (bg-muted/50 or similar)
    - **Key metrics bar** at top: horizontal row showing Lead Score (large, color-coded), ICP Match %, Industry, Company Size, Date Analyzed. Use flex with gap, items centered. Each metric in a small labeled box.
    - **Collapsible sections** below metrics bar, using the existing Collapsible component from ui/collapsible.tsx:
      - "Score Breakdown" - renders `<ScoreBreakdown>` from components/analysis/score-breakdown.tsx
      - "Company Insights" - renders `<CompanyInsights>` from components/analysis/company-insights.tsx
      - "Pitch Angles" - renders `<PitchAngles>` from components/analysis/pitch-angles.tsx
      - "Objections & Responses" - renders `<ObjectionCards>` from components/analysis/objection-cards.tsx
    - All sections collapsed by default. Each section header has a chevron icon (lucide ChevronDown) that rotates when open.
    - Each collapsible section uses the Radix Collapsible trigger/content pattern.
    - Pass the correct props to each reused component (check their interfaces in the source files).

    2. Update `src/app/(protected)/dashboard/_components/lead-grid.tsx`:
    - Replace the placeholder expanded content with `<LeadDetail analysis={lead.analysis} company={lead.company} />`
    - Import LeadDetail
    - Ensure the Collapsible wrapping the detail view has smooth open/close animation (use CSS: `data-[state=open]:animate-in data-[state=closed]:animate-out` or simple transition on the Collapsible.Content)
  </action>
  <verify>
    `npm run build` compiles. Click a lead card - expanded detail shows key metrics bar and 4 collapsible sections. Click each section header to expand/reveal content. Verify ScoreBreakdown, CompanyInsights, PitchAngles, ObjectionCards render correctly with real data.
  </verify>
  <done>
    Expanding detail view shows key metrics bar + 4 collapsible sections. Reuses existing analysis components. Smooth expand/collapse animation. Only one card expanded at a time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build action menu with all CRUD actions</name>
  <files>
    src/app/(protected)/dashboard/_components/action-menu.tsx
    src/app/(protected)/dashboard/_components/lead-card.tsx
    src/app/(protected)/dashboard/_components/lead-grid.tsx
    src/app/(protected)/dashboard/page.tsx
  </files>
  <action>
    1. Create `src/app/(protected)/dashboard/_components/action-menu.tsx` as 'use client' component:

    **Props:**
    ```typescript
    interface ActionMenuProps {
      analysisId: string
      isArchived: boolean
      lead: { analysis: Analysis; company: Company }
      onArchive: (id: string) => void
      onUnarchive: (id: string) => void
      onReanalyze: (companyDomain: string) => void
      onCopyToClipboard: (lead: { analysis: Analysis; company: Company }) => void
      onExportCSV: (lead: { analysis: Analysis; company: Company }) => void
    }
    ```

    **UI:** Button with MoreVertical icon (lucide). On click, show a dropdown menu (build as a simple positioned div with absolute positioning, not a full Radix dropdown - keep it lightweight). Menu items:
    - "Copy to Clipboard" (lucide Copy icon) - calls `onCopyToClipboard`
    - "Export as CSV" (lucide Download icon) - calls `onExportCSV`
    - Separator line
    - "Re-analyze" (lucide RefreshCw icon) - calls `onReanalyze`
    - "Archive" / "Unarchive" (lucide Archive/ArchiveRestore icon) - calls `onArchive` or `onUnarchive` based on isArchived prop
    - Menu closes on item click and on click outside (useEffect with click outside listener)
    - Each item has hover state

    2. Update `lead-card.tsx`:
    - Replace three-dot placeholder with `<ActionMenu>` component
    - Stop event propagation on ActionMenu click so card doesn't toggle expand
    - Wire up action callbacks from props

    3. Update `lead-grid.tsx`:
    - Add action handler functions:
      - `handleArchive(id)`: call `archiveLead(id)` server action, then remove from local state (use `useOptimistic` or simple state filter for instant UI update, revalidation handles server sync)
      - `handleUnarchive(id)`: call `unarchiveLead(id)` server action
      - `handleReanalyze(domain)`: navigate to `/analyze?url=https://${domain}` using router.push
      - `handleCopyToClipboard(lead)`: call `leadToClipboardText(lead)` then `copyToClipboard(text)`, show success/error feedback (simple state-based toast message at top of grid, auto-dismiss after 3 seconds - no need for a toast library)
      - `handleExportCSV(lead)`: call `leadsToCSV([lead])` then `downloadCSV(csv, filename)`
    - Import server actions from queries.ts and utils from dashboard/utils.ts
    - Use `useRouter` for navigation, `useTransition` for server action pending states

    4. Update `page.tsx`:
    - Add "Export All" / "Export Filtered" button in the header area next to "Analyze New Lead"
    - This button calls a client-side function that takes all currently displayed leads and generates CSV
    - Pass leads data to LeadGrid so it can handle bulk export
    - Add archive toggle: a subtle "Show archived" checkbox/toggle in the filter bar area. When toggled, adds `showArchived=true` to URL params. This allows viewing archived leads.

    5. Wire `useRouter().refresh()` after archive/unarchive actions to refetch server data.
  </action>
  <verify>
    `npm run build` compiles. Test each action:
    - Three-dot menu opens/closes correctly
    - "Copy to Clipboard" copies CRM-formatted text (paste into text editor to verify)
    - "Export as CSV" downloads a .csv file with correct data
    - "Archive" removes lead from view (reappears with "Show archived" toggle)
    - "Re-analyze" navigates to /analyze with pre-filled URL
    - "Export All" button downloads CSV with all visible leads
  </verify>
  <done>
    Three-dot action menu works on all cards. Copy to clipboard produces CRM-friendly text. CSV export downloads correctly. Archive removes from active view. Re-analyze navigates to analyze page with URL. Bulk export button works for filtered set.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero errors
- DASH-02: Click card -> expanded detail with score breakdown, insights, pitches, objections
- DASH-07: CSV export works (single lead + bulk filtered export)
- DASH-08: Clipboard copy produces plain text CRM format
- DASH-09: Archive removes lead; "Show archived" toggle reveals archived leads; unarchive restores
- DASH-10: Re-analyze navigates to /analyze with company URL
- All collapsible sections in detail view open/close independently
- Action menu opens/closes cleanly, doesn't trigger card expand
</verification>

<success_criteria>
- Full analysis detail visible in expanding card (DASH-02)
- CSV export functional for single and bulk leads (DASH-07)
- Clipboard copy produces CRM-compatible plain text (DASH-08)
- Archive/unarchive workflow functional (DASH-09)
- Re-analyze navigates correctly (DASH-10)
- All 10 DASH requirements covered across plans 01-03
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard/05-03-SUMMARY.md`
</output>
