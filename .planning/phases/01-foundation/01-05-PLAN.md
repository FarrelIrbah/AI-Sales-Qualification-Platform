---
phase: 01-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - src/app/(protected)/layout.tsx
  - src/app/(protected)/dashboard/page.tsx
  - src/app/(protected)/onboarding/page.tsx
  - src/components/auth/user-nav.tsx
autonomous: false

must_haves:
  truths:
    - "Unauthenticated users are redirected to /login when accessing /dashboard"
    - "Authenticated users can access /dashboard without redirect"
    - "User session persists across browser refresh"
    - "User can sign out and is redirected to login"
    - "New users are directed to /onboarding after signup"
    - "Password reset email contains working link"
  artifacts:
    - path: "src/app/(protected)/layout.tsx"
      provides: "Protected route layout with auth check"
      min_lines: 10
    - path: "src/app/(protected)/dashboard/page.tsx"
      provides: "Dashboard page for authenticated users"
      min_lines: 10
    - path: "src/components/auth/user-nav.tsx"
      provides: "User navigation with sign out"
      exports: ["UserNav"]
  key_links:
    - from: "src/app/(protected)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "createClient for auth check"
      pattern: "createClient"
    - from: "src/app/(protected)/layout.tsx"
      to: "redirect('/login')"
      via: "unauthenticated redirect"
      pattern: "redirect.*login"
---

<objective>
Create protected routes, integrate all auth flows, and verify end-to-end authentication works.

Purpose: Complete the auth system with route protection and verify all requirements are met.
Output: Working protected routes, dashboard shell, and verified auth flows for all requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create protected route layout and pages</name>
  <files>
    - src/app/(protected)/layout.tsx
    - src/app/(protected)/dashboard/page.tsx
    - src/app/(protected)/onboarding/page.tsx
    - src/components/auth/user-nav.tsx
  </files>
  <action>
Create the protected route group with auth checking:

**src/app/(protected)/layout.tsx**:
```tsx
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { UserNav } from '@/components/auth/user-nav'

export default async function ProtectedLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // Get profile for display
  const { data: profile } = await supabase
    .from('profiles')
    .select('full_name, email, avatar_url')
    .eq('id', user.id)
    .single()

  return (
    <div className="min-h-screen bg-background">
      <header className="border-b">
        <div className="container mx-auto flex h-16 items-center justify-between px-4">
          <div className="font-bold text-xl">LeadQual</div>
          <UserNav
            user={{
              email: profile?.email || user.email || '',
              name: profile?.full_name || null,
              avatarUrl: profile?.avatar_url || null,
            }}
          />
        </div>
      </header>
      <main className="container mx-auto px-4 py-8">
        {children}
      </main>
    </div>
  )
}
```

**src/components/auth/user-nav.tsx**:
```tsx
'use client'

import { Button } from '@/components/ui/button'
import { signOut } from '@/lib/auth/actions'

interface UserNavProps {
  user: {
    email: string
    name: string | null
    avatarUrl: string | null
  }
}

export function UserNav({ user }: UserNavProps) {
  return (
    <div className="flex items-center gap-4">
      <span className="text-sm text-muted-foreground">
        {user.name || user.email}
      </span>
      <form action={signOut}>
        <Button variant="outline" size="sm" type="submit">
          Sign out
        </Button>
      </form>
    </div>
  )
}
```

**src/app/(protected)/dashboard/page.tsx**:
```tsx
import { createClient } from '@/lib/supabase/server'

export default async function DashboardPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Dashboard</h1>
        <p className="text-muted-foreground">
          Welcome back! You&apos;re signed in as {user?.email}
        </p>
      </div>

      <div className="rounded-lg border p-6">
        <h2 className="text-lg font-semibold mb-2">Getting Started</h2>
        <p className="text-muted-foreground">
          Your LeadQual dashboard will show analyzed leads here.
          Start by completing your ICP setup.
        </p>
      </div>
    </div>
  )
}
```

**src/app/(protected)/onboarding/page.tsx**:
```tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@/components/ui/button'

export default async function OnboardingPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // Check if user has already completed onboarding
  const { data: profile } = await supabase
    .from('profiles')
    .select('has_completed_onboarding')
    .eq('id', user.id)
    .single()

  if (profile?.has_completed_onboarding) {
    redirect('/dashboard')
  }

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Welcome to LeadQual!</h1>
        <p className="text-muted-foreground mt-2">
          Let&apos;s set up your Ideal Customer Profile to get personalized lead analysis.
        </p>
      </div>

      <div className="rounded-lg border p-6 space-y-4">
        <h2 className="text-lg font-semibold">ICP Setup (Coming in Phase 2)</h2>
        <p className="text-muted-foreground">
          The ICP wizard will guide you through defining your ideal customer.
          For now, you can skip to the dashboard.
        </p>

        <Button asChild>
          <Link href="/dashboard">Continue to Dashboard</Link>
        </Button>
      </div>
    </div>
  )
}
```

These components create:
1. Protected layout that checks auth and redirects unauthenticated users
2. UserNav showing user info with sign out button
3. Dashboard page showing welcome message
4. Onboarding placeholder page for new users
  </action>
  <verify>
1. Visit `/dashboard` while not logged in - should redirect to `/login`
2. Sign in, then visit `/dashboard` - should show dashboard content
3. Click sign out - should redirect to `/login`
  </verify>
  <done>
Protected routes created with auth checking. Unauthenticated users redirected to login. Sign out works correctly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete auth flow</name>
  <what-built>
Complete authentication system with:
- Email/password signup and signin
- Google OAuth signin
- Password reset flow
- Protected routes with auth checking
- Session persistence across refresh
  </what-built>
  <how-to-verify>

**Prerequisites:**
1. Ensure `.env.local` is created with Supabase credentials
2. Run the SQL migration in Supabase SQL Editor (from Plan 02)
3. Enable Google OAuth in Supabase Dashboard (optional for Google test)

**Test AUTH-01: User can create account with email and password**
1. Visit `http://localhost:3000/signup`
2. Fill in name, email, and password (8+ chars, upper, lower, number)
3. Click "Create account"
4. Should redirect to `/onboarding`
5. Check Supabase Dashboard > Authentication > Users - user should exist
6. Check Supabase Dashboard > Table Editor > profiles - profile row should exist

**Test AUTH-02: User session persists across browser refresh**
1. While logged in, refresh the page (F5 or Ctrl+R)
2. Should still be on protected page, not redirected to login
3. Close browser tab, open new tab, go to `/dashboard`
4. Should still be authenticated (session persists)

**Test AUTH-03: User can reset password via email link**
1. Sign out (click "Sign out" button)
2. Visit `/forgot-password`
3. Enter email used for signup
4. Click "Send reset link"
5. Should show "Check your email" success message
6. Check email inbox (or Supabase Dashboard > Authentication > Users > click user > "Password Recovery")
7. Click the reset link in email
8. Should arrive at `/update-password` page
9. Enter new password and confirm
10. Should redirect to `/dashboard` after update

**Test AUTH-04: User can sign in with Google OAuth** (if configured)
1. Visit `/login`
2. Click "Continue with Google"
3. Complete Google sign-in flow
4. Should redirect to `/onboarding` (new user) or `/dashboard` (returning user)
5. Check profiles table - should have entry with Google info

**Test Protected Routes:**
1. Sign out
2. Try to visit `/dashboard` directly
3. Should redirect to `/login`
4. Sign in
5. Should be able to access `/dashboard`

  </how-to-verify>
  <resume-signal>
Type "approved" if all auth flows work correctly, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
All four AUTH requirements verified:

| Requirement | Test | Expected Outcome |
|-------------|------|------------------|
| AUTH-01 | Signup with email/password | Redirects to onboarding, user + profile created |
| AUTH-02 | Refresh browser while logged in | Session persists, no re-login required |
| AUTH-03 | Request password reset | Email received with working reset link |
| AUTH-04 | Sign in with Google | OAuth flow completes, user + profile created |

Additional verifications:
- Protected routes redirect unauthenticated users to /login
- Sign out clears session and redirects to /login
- Validation errors display on invalid form input
</verification>

<success_criteria>
- [ ] AUTH-01: User can create account with email/password - redirected to onboarding
- [ ] AUTH-02: Session persists across browser refresh without re-login
- [ ] AUTH-03: Password reset email received with working reset link
- [ ] AUTH-04: Google OAuth flow completes successfully
- [ ] Protected routes redirect unauthenticated users to /login
- [ ] User can sign out and is redirected to login
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
