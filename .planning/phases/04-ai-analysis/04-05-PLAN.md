---
phase: 04-ai-analysis
plan: 05
type: execute
wave: 4
depends_on: ["04-03", "04-04"]
files_modified:
  - src/app/(protected)/analyze/page.tsx
autonomous: false

must_haves:
  truths:
    - "Analysis auto-starts after extraction completes"
    - "User sees analysis progress during AI processing"
    - "User sees complete analysis results on single scrollable page"
    - "User can click 'Analyze Another' or 'View Dashboard' after completion"
  artifacts:
    - path: "src/app/(protected)/analyze/page.tsx"
      provides: "Complete analyze flow with extraction -> analysis -> results"
      min_lines: 200
  key_links:
    - from: "src/app/(protected)/analyze/page.tsx"
      to: "src/components/analysis/analysis-progress.tsx"
      via: "Component import and render"
      pattern: "AnalysisProgress"
    - from: "src/app/(protected)/analyze/page.tsx"
      to: "src/components/analysis/lead-score-card.tsx"
      via: "Component import and render"
      pattern: "LeadScoreCard"
    - from: "src/app/(protected)/analyze/page.tsx"
      to: "src/lib/analysis/schemas.ts"
      via: "Type import for ViewState"
      pattern: "AnalysisResult"
---

<objective>
Integrate all analysis components into the analyze page for complete extraction-to-results flow.

Purpose: Users need a seamless experience from URL input through AI analysis to actionable results.

Output: Updated analyze page with full analysis flow and results display.
</objective>

<execution_context>
@C:\Users\farre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\farre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-analysis/04-CONTEXT.md
@.planning/phases/04-ai-analysis/04-RESEARCH.md
@.planning/phases/04-ai-analysis/04-03-SUMMARY.md
@.planning/phases/04-ai-analysis/04-04-SUMMARY.md

@src/app/(protected)/analyze/page.tsx
@src/components/analysis/analysis-progress.tsx
@src/components/analysis/lead-score-card.tsx
@src/components/analysis/score-breakdown.tsx
@src/components/analysis/company-insights.tsx
@src/components/analysis/pitch-angles.tsx
@src/components/analysis/objection-cards.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ViewState for Analysis Flow</name>
  <files>src/app/(protected)/analyze/page.tsx</files>
  <action>
Update the discriminated union ViewState to include analysis states per CONTEXT.md: "Analysis auto-starts after extraction completes".

New ViewState:
```typescript
type ViewState =
  | { type: 'input' }
  | { type: 'extracting'; url: string }
  | { type: 'manual'; partialData: PartialCompanyData; missingFields: string[] }
  | { type: 'analyzing'; companyData: PartialCompanyData; url: string }  // NEW
  | { type: 'result'; analysisId: string; analysis: AnalysisResult; companyData: PartialCompanyData }  // UPDATED
```

Update handlers:
1. `handleExtractionComplete` - Instead of showing extraction result, transition to 'analyzing' state
2. `handleManualSubmit` - After manual input, transition to 'analyzing' state
3. Add `handleAnalysisComplete` - Transition to 'result' with full analysis
4. Add `handleAnalysisError` - Show error or fallback to manual

Remove the old 'result' state that just showed extraction data.
Remove `handleProceedToAnalysis` (analysis now auto-starts).

Import AnalysisResult type from @/lib/analysis/schemas.
  </action>
  <verify>
Page compiles without TypeScript errors.
State transitions work: input -> extracting -> analyzing -> result.
  </verify>
  <done>
ViewState extended with 'analyzing' state. Analysis auto-starts after extraction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Analysis Progress and Results Views</name>
  <files>src/app/(protected)/analyze/page.tsx</files>
  <action>
Add new view renders for 'analyzing' and 'result' states.

**Analyzing view:**
```tsx
{view.type === 'analyzing' && (
  <Card>
    <CardHeader>
      <CardTitle>Analyzing Lead</CardTitle>
      <CardDescription>
        Generating personalized recommendations based on your ICP
      </CardDescription>
    </CardHeader>
    <CardContent>
      <AnalysisProgress
        companyData={view.companyData}
        url={view.url}
        onComplete={handleAnalysisComplete}
        onError={handleAnalysisError}
      />
    </CardContent>
  </Card>
)}
```

**Result view (single scrollable page per CONTEXT.md):**
Section order: Lead score + breakdown -> Company insights -> Pitch angles -> Objections

```tsx
{view.type === 'result' && (
  <div className="space-y-6">
    {/* Lead Score Card */}
    <LeadScoreCard
      leadScore={view.analysis.leadScore}
      icpMatchPercentage={view.analysis.icpMatchPercentage}
      companyName={view.companyData.name || 'Unknown Company'}
    />

    {/* Score Breakdown */}
    <Card>
      <CardHeader>
        <CardTitle>Score Breakdown</CardTitle>
      </CardHeader>
      <CardContent>
        <ScoreBreakdown
          componentScores={view.analysis.componentScores}
          icpMatchPercentage={view.analysis.icpMatchPercentage}
        />
      </CardContent>
    </Card>

    {/* Company Insights */}
    <CompanyInsights
      insights={view.analysis.insights}
      companyData={view.companyData}
    />

    {/* Pitch Angles */}
    <Card>
      <CardHeader>
        <CardTitle>Pitch Angles</CardTitle>
        <CardDescription>Personalized approaches for this lead</CardDescription>
      </CardHeader>
      <CardContent>
        <PitchAngles pitchAngles={view.analysis.pitchAngles} />
      </CardContent>
    </Card>

    {/* Objections */}
    <Card>
      <CardHeader>
        <CardTitle>Predicted Objections</CardTitle>
        <CardDescription>Likely pushbacks with recommended responses</CardDescription>
      </CardHeader>
      <CardContent>
        <ObjectionCards objections={view.analysis.objections} />
      </CardContent>
    </Card>

    {/* Actions */}
    <div className="flex gap-4">
      <Button variant="outline" onClick={handleAnalyzeAnother} className="flex-1">
        Analyze Another
      </Button>
      <Button onClick={() => router.push('/dashboard')} className="flex-1">
        View Dashboard
      </Button>
    </div>
  </div>
)}
```

Import all analysis components at top of file.
Add `handleAnalyzeAnother` that resets to 'input' state.
  </action>
  <verify>
Page renders all analysis sections correctly.
Results are scrollable on single page.
Both action buttons work.
  </verify>
  <done>
Analysis results display in correct section order with "Analyze Another" and "View Dashboard" actions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete analyze flow: URL input -> extraction -> AI analysis -> results display with scores, breakdowns, pitches, and objections.
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Log in and ensure you have completed onboarding (have an ICP)
3. Navigate to /analyze
4. Enter a company URL (e.g., https://stripe.com or https://vercel.com)
5. Watch extraction progress
6. Watch analysis progress (4 steps)
7. Verify results page shows:
   - Large lead score number with correct color (green/yellow/red)
   - ICP match percentage
   - Component score bars that expand when clicked
   - Company insights with summary + strengths + concerns
   - 2-3 pitch angles with headlines
   - Predicted objections with responses
8. Click "Analyze Another" - should return to URL input
9. Click "View Dashboard" - should navigate to /dashboard
  </how-to-verify>
  <resume-signal>Type "approved" if flow works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. Full flow works: URL -> extraction -> analysis -> results
3. All analysis sections render correctly
4. Score colors match thresholds
5. Component scores expand to show reasoning
6. Actions (Analyze Another, View Dashboard) work
</verification>

<success_criteria>
- User sees lead score (1-100) with breakdown after analysis (ANLZ-01, ANLZ-02)
- User sees ICP match percentage with breakdown (ANLZ-03)
- User sees company insights with AI commentary (ANLZ-04)
- User sees 2-3 personalized pitch angles (ANLZ-05)
- User sees predicted objections with responses (ANLZ-06, ANLZ-07)
- Flow is seamless from extraction to analysis to results
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-analysis/04-05-SUMMARY.md`
</output>
