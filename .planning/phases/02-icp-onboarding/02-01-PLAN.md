---
phase: 02-icp-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/validations/icp.ts
  - src/lib/ai/index.ts
  - src/lib/ai/prompts/icp-parser.ts
  - package.json
autonomous: true
user_setup:
  - service: openai
    why: "AI-powered ICP parsing from natural language"
    env_vars:
      - name: OPENAI_API_KEY
        source: "OpenAI Platform -> API keys -> Create new secret key"
    dashboard_config: []

must_haves:
  truths:
    - "ICP data structure exists in database"
    - "Zod schemas validate all ICP fields"
    - "AI SDK is configured and can generate structured output"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "icpProfiles table definition"
      contains: "icpProfiles"
    - path: "src/lib/validations/icp.ts"
      provides: "Zod schemas for all ICP steps"
      exports: ["companyInfoSchema", "targetCriteriaSchema", "valuePropsSchema", "objectionsSchema", "fullIcpSchema"]
    - path: "src/lib/ai/index.ts"
      provides: "OpenAI provider setup"
      exports: ["openai", "gpt4o"]
    - path: "src/lib/ai/prompts/icp-parser.ts"
      provides: "ICP parsing functions with structured output"
      exports: ["parseCompanyInfo", "parseTargetCriteria", "parseValueProps", "parseObjections"]
  key_links:
    - from: "src/lib/ai/prompts/icp-parser.ts"
      to: "src/lib/validations/icp.ts"
      via: "import Zod schemas for Output.object()"
      pattern: "import.*from.*validations/icp"
    - from: "src/lib/db/schema.ts"
      to: "profiles table"
      via: "foreign key reference"
      pattern: "references.*profiles"
---

<objective>
Set up ICP database schema, Zod validation schemas, and AI SDK for natural language parsing.

Purpose: Establish the data layer and AI infrastructure needed for the ICP wizard. All subsequent plans depend on these schemas and AI parsing functions.

Output: Database table for ICP profiles, type-safe validation schemas for wizard steps, and AI parsing functions using Vercel AI SDK 6 with structured output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-icp-onboarding/02-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/validations/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AI SDK and add ICP database schema</name>
  <files>
    package.json
    src/lib/db/schema.ts
  </files>
  <action>
Install Vercel AI SDK packages:
```bash
npm install ai @ai-sdk/openai
```

Extend `src/lib/db/schema.ts` to add `icpProfiles` table:
- `id`: UUID primary key (defaultRandom)
- `userId`: UUID foreign key to profiles.id (cascade delete)
- Company info fields (flat for common queries):
  - `productDescription`: text, not null
  - `industry`: text, not null
  - `companySize`: text, not null (solo/small/medium/large/enterprise)
  - `targetMarket`: text, not null (b2b/b2c/both)
- Complex nested data as JSONB:
  - `targetCriteria`: jsonb, not null - contains idealCompanySizes[], targetIndustries[], targetLocations[], techRequirements[], budgetRange?
  - `valuePropositions`: jsonb, not null - array of {headline, description, differentiators[]}
  - `commonObjections`: jsonb, not null - array of {objection, suggestedResponse?}
- Timestamps: createdAt, updatedAt (both with timezone, default now)

Use Drizzle's `$type<T>()` for JSONB type inference. Export `IcpProfile` and `NewIcpProfile` types.

Also update profiles table reference to use Drizzle's relations pattern if not already using it.
  </action>
  <verify>
Run `npx drizzle-kit generate` to verify schema is valid. Check generated SQL has correct table structure.
  </verify>
  <done>
icpProfiles table defined with all fields, JSONB columns typed, AI SDK packages in package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas for ICP</name>
  <files>
    src/lib/validations/icp.ts
  </files>
  <action>
Create `src/lib/validations/icp.ts` following the pattern from `auth.ts`.

Define schemas for each wizard step:

1. `companyInfoSchema`:
   - productDescription: string, min 10, max 500
   - industry: string, min 2
   - companySize: enum ['solo', 'small', 'medium', 'large', 'enterprise']
   - targetMarket: enum ['b2b', 'b2c', 'both']

2. `targetCriteriaSchema`:
   - idealCompanySizes: array of strings, min 1
   - targetIndustries: array of strings, min 1
   - targetLocations: array of strings, default []
   - techRequirements: array of strings, default []
   - budgetRange: optional object { min?: number, max?: number }

3. `valuePropsSchema`:
   - valuePropositions: array of objects with:
     - headline: string, min 5
     - description: string, min 20
     - differentiators: array of strings
   - Array must have min 1 item

4. `objectionsSchema`:
   - commonObjections: array of objects with:
     - objection: string, min 10
     - suggestedResponse: optional string
   - Default empty array (objections are optional)

5. `fullIcpSchema`: Merge all four schemas

Export all schemas and their inferred types (CompanyInfoInput, TargetCriteriaInput, etc.).

Add .describe() to fields that AI will parse - these descriptions guide the AI extraction.
  </action>
  <verify>
Create a simple test file that validates sample data against each schema. Run with `npx tsx` to confirm schemas work.
  </verify>
  <done>
All 5 Zod schemas exported with types, field descriptions for AI parsing included.
  </done>
</task>

<task type="auto">
  <name>Task 3: Set up AI SDK and ICP parsing functions</name>
  <files>
    src/lib/ai/index.ts
    src/lib/ai/prompts/icp-parser.ts
  </files>
  <action>
Create `src/lib/ai/index.ts`:
```typescript
import { createOpenAI } from '@ai-sdk/openai'

export const openai = createOpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

export const gpt4o = openai('gpt-4o')
export const gpt4oMini = openai('gpt-4o-mini')
```

Create `src/lib/ai/prompts/icp-parser.ts` with parsing functions for each ICP section:

1. `parseCompanyInfo(input: string)` - extracts company info from natural language
2. `parseTargetCriteria(input: string)` - extracts target customer criteria
3. `parseValueProps(input: string)` - extracts value propositions
4. `parseObjections(input: string)` - extracts common objections

Each function should:
- Use `generateText` from 'ai' package with `Output.object()` pattern (NOT deprecated generateObject)
- Import corresponding Zod schema from validations/icp.ts
- Include a focused system prompt explaining what to extract
- Return the parsed object matching the schema
- Handle errors gracefully (return null or throw descriptive error)

Example pattern (from research):
```typescript
import { generateText, Output } from 'ai'
import { gpt4o } from '@/lib/ai'
import { targetCriteriaSchema } from '@/lib/validations/icp'

export async function parseTargetCriteria(input: string) {
  const { output } = await generateText({
    model: gpt4o,
    output: Output.object({
      schema: targetCriteriaSchema,
    }),
    system: `You extract ideal customer criteria...`,
    prompt: input,
  })
  return output
}
```

System prompts should be specific to each section:
- Company info: Extract what they sell, their industry, size, B2B vs B2C
- Target criteria: Extract ideal customer sizes, industries, locations, tech requirements
- Value props: Extract key benefits, differentiators, unique selling points
- Objections: Extract common pushbacks they face from prospects
  </action>
  <verify>
Create a test script that calls each parsing function with sample input. Verify structured output is returned. Note: Requires OPENAI_API_KEY to be set.
  </verify>
  <done>
AI SDK configured, 4 parsing functions exported, each using AI SDK 6 Output.object() pattern with correct Zod schemas.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without TypeScript errors
2. Schema file exports both profile and icpProfiles tables
3. Validation schemas all export correctly (can be imported in other files)
4. AI parsing functions use correct AI SDK 6 pattern (not deprecated generateObject)
5. JSONB columns have proper TypeScript types via $type<T>()
</verification>

<success_criteria>
- icpProfiles table defined with all ICP fields (company info + JSONB columns)
- 5 Zod schemas (one per step + combined) with type exports
- AI SDK configured with OpenAI provider
- 4 ICP parsing functions using structured output
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/02-icp-onboarding/02-01-SUMMARY.md`
</output>
