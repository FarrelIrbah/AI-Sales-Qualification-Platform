---
phase: 02-icp-onboarding
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/app/(protected)/onboarding/page.tsx
  - src/app/(protected)/settings/icp/page.tsx
  - src/app/(protected)/layout.tsx
  - src/components/onboarding/icp-wizard.tsx
autonomous: false

must_haves:
  truths:
    - "New user sees ICP wizard during onboarding"
    - "User can complete wizard and is redirected to dashboard"
    - "User can access ICP settings and edit any field"
    - "Existing ICP data loads when user returns"
  artifacts:
    - path: "src/app/(protected)/onboarding/page.tsx"
      provides: "Onboarding page with embedded wizard"
      min_lines: 20
    - path: "src/app/(protected)/settings/icp/page.tsx"
      provides: "ICP settings page for editing"
      min_lines: 30
  key_links:
    - from: "src/app/(protected)/onboarding/page.tsx"
      to: "src/components/onboarding/icp-wizard.tsx"
      via: "component import"
      pattern: "IcpWizard"
    - from: "src/components/onboarding/icp-wizard.tsx"
      to: "/api/icp"
      via: "fetch on submit"
      pattern: "fetch.*api/icp"
---

<objective>
Integrate ICP wizard into onboarding flow and create settings page for ICP editing.

Purpose: Wire up all the wizard components to the actual user flow. New users complete the wizard during onboarding, existing users can edit their ICP in settings. This completes all ICP requirements.

Output: Working onboarding flow with ICP wizard, settings page for editing, and human verification of the complete flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-icp-onboarding/02-RESEARCH.md
@.planning/phases/02-icp-onboarding/02-02-SUMMARY.md
@.planning/phases/02-icp-onboarding/02-03-SUMMARY.md
@src/app/(protected)/onboarding/page.tsx
@src/app/(protected)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update onboarding page to use ICP wizard</name>
  <files>
    src/app/(protected)/onboarding/page.tsx
  </files>
  <action>
Update `src/app/(protected)/onboarding/page.tsx`:
- Keep existing auth check (redirect to login if not authenticated)
- Keep existing onboarding check (redirect to dashboard if already completed)
- Replace placeholder content with IcpWizard component
- Pass onComplete callback that:
  1. Calls POST /api/icp with form data
  2. Shows success toast/message
  3. Redirects to /dashboard using router.push

Page structure:
```tsx
export default async function OnboardingPage() {
  // Server-side auth check (keep existing)
  // Server-side onboarding check (keep existing)

  return (
    <div className="max-w-3xl mx-auto">
      <div className="mb-8">
        <h1 className="text-3xl font-bold">Welcome to LeadQual!</h1>
        <p className="text-muted-foreground mt-2">
          Let's set up your Ideal Customer Profile for personalized lead analysis.
        </p>
      </div>

      <IcpWizard mode="onboarding" />
    </div>
  )
}
```

Update IcpWizard to accept props:
- mode: 'onboarding' | 'settings'
- initialData?: Partial<IcpFormData>
- In onboarding mode: show "Complete Setup" on final step
- In settings mode: show "Save Changes" and allow saving from any step
  </action>
  <verify>
Navigate to /onboarding as a new user. Should see ICP wizard instead of placeholder.
  </verify>
  <done>
Onboarding page shows ICP wizard for new users, wizard submits to API and redirects on success.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ICP settings page and add navigation</name>
  <files>
    src/app/(protected)/settings/icp/page.tsx
    src/app/(protected)/layout.tsx
  </files>
  <action>
Create `src/app/(protected)/settings/icp/page.tsx`:
- Server component for initial data fetch
- Auth check (redirect to login if not authenticated)
- Fetch existing ICP from /api/icp or direct Drizzle query
- Pass ICP data to IcpWizard as initialData
- Mode: 'settings'

```tsx
export default async function IcpSettingsPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/login')

  // Fetch existing ICP
  const existingIcp = await db.query.icpProfiles.findFirst({
    where: eq(icpProfiles.userId, user.id)
  })

  return (
    <div className="max-w-3xl mx-auto">
      <div className="mb-8">
        <h1 className="text-2xl font-bold">Ideal Customer Profile</h1>
        <p className="text-muted-foreground">
          Update your ICP to improve lead scoring accuracy.
        </p>
      </div>

      <IcpWizard
        mode="settings"
        initialData={existingIcp ? transformToFormData(existingIcp) : undefined}
      />
    </div>
  )
}
```

Helper function to transform DB ICP to form data format (handle JSONB -> nested objects).

Update `src/app/(protected)/layout.tsx`:
- Add Settings link in header navigation
- Dropdown or side nav with "ICP Settings" option
- Use existing UserNav pattern or create simple nav links

Navigation options:
- Simple: Add "Settings" link next to user nav that goes to /settings/icp
- Or: Create settings dropdown with ICP as first option (extensible for future settings)
  </action>
  <verify>
Navigate to /settings/icp. Should see ICP wizard pre-filled with existing data. Save changes should update.
  </verify>
  <done>
Settings page loads existing ICP, allows editing, saves changes. Navigation link added to protected layout.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete ICP onboarding flow:
1. New user authentication -> onboarding wizard
2. 4-step wizard with form validation
3. AI-powered natural language input (requires OPENAI_API_KEY)
4. ICP persistence to database
5. Settings page for editing ICP
  </what-built>
  <how-to-verify>
**Test 1: New User Onboarding (ICP-01 through ICP-05)**
1. Create a new account or clear has_completed_onboarding flag
2. After login, should redirect to /onboarding
3. Should see 4-step ICP wizard with progress indicator
4. Complete each step:
   - Step 1: Enter company info (or use AI input)
   - Step 2: Enter target criteria with tag inputs
   - Step 3: Add at least one value proposition
   - Step 4: Optionally add objections
5. Click "Complete Setup"
6. Should redirect to /dashboard

**Test 2: AI Parsing (ICP-06)**
1. In Step 1, enter natural language like "We sell project management software to mid-size tech companies"
2. Click "Extract with AI"
3. Form fields should auto-populate with extracted data
4. Verify fields can still be edited after AI extraction

**Test 3: ICP Editing (ICP-07)**
1. Navigate to Settings (or /settings/icp)
2. Should see existing ICP data loaded in form
3. Make changes to any field
4. Click "Save Changes"
5. Refresh page - changes should persist

**Test 4: Data Persistence**
1. Complete onboarding
2. Log out and log back in
3. Navigate to /settings/icp
4. All previously entered ICP data should be loaded
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe specific issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. New users see ICP wizard on /onboarding
3. Completed onboarding redirects to /dashboard
4. ICP settings page loads and saves correctly
5. AI parsing populates form fields
6. All ICP-01 through ICP-07 requirements satisfied
</verification>

<success_criteria>
- ICP-01: User completes ICP setup wizard during onboarding
- ICP-02: Wizard captures company info (product, industry, size, market)
- ICP-03: Wizard captures target criteria (sizes, industries, locations, tech)
- ICP-04: Wizard captures value propositions (headline, description, differentiators)
- ICP-05: Wizard captures common objections (objection, response)
- ICP-06: AI parses natural language into structured ICP fields
- ICP-07: User can edit ICP anytime in settings
</success_criteria>

<output>
After completion, create `.planning/phases/02-icp-onboarding/02-04-SUMMARY.md`
</output>
